<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Оставьте отзыв о Gio`s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
 <h1 style="color:#dddddd;">Оставьте отзыв о Gio`s</h1>

  <!-- Блок кнопок + звёзды -->
  <div class="button-group">

    <!-- 1. Отзыв управляющему — сразу форма -->
    <button class="btn accent" onclick="showForm()">Отзыв управляющему</button>

    <!-- 2. Яндекс Карты + звёзды -->
    <button class="btn external" onclick="rateAndGo('yandex')">Яндекс Карты</button>
    <div id="yandexStars" class="stars" style="display:none;">
      <span class="star" data-v="1">★</span>
      <span class="star" data-v="2">★</span>
      <span class="star" data-v="3">★</span>
      <span class="star" data-v="4">★</span>
      <span class="star" data-v="5">★</span>
    </div>
    <button id="yandexGoBtn" class="btn accent" style="display:none;" onclick="submitRating('yandex')">Отправить оценку</button>

    <!-- 3. Google Карты + звёзды -->
    <button class="btn external" onclick="rateAndGo('google')">Google Карты</button>
    <div id="googleStars" class="stars" style="display:none;">
      <span class="star" data-v="1">★</span>
      <span class="star" data-v="2">★</span>
      <span class="star" data-v="3">★</span>
      <span class="star" data-v="4">★</span>
      <span class="star" data-v="5">★</span>
    </div>
    <button id="googleGoBtn" class="btn accent" style="display:none;" onclick="submitRating('google')">Отправить оценку</button>

  </div>

  <!-- ЕДИНАЯ форма управляющему -->
  <form id="managerForm" style="display:none;" onsubmit="sendReview(event)">
    <input type="hidden" id="user_id" value="">
    <input type="text" id="fio" placeholder="ФИО" required>
    <input type="date" id="date" required>
    <input type="tel" id="phone" placeholder="Номер телефона для связи" required>
    <textarea id="text" placeholder="Как всё прошло?" required></textarea>
    <button type="submit">Отправить</button>
  </form>

<script>
    /* --- СИСТЕМА ТРЕКИНГА --- */
    
    // 1. Функция отправки данных на сервер
    async function trackEvent(type, target) {
        try {
            await fetch('/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, target })
            });
        } catch (e) {
            console.error('Ошибка трекинга:', e);
        }
    }

    // 2. Отслеживаем посещение страницы сразу при загрузке
    document.addEventListener('DOMContentLoaded', () => {
        trackEvent('visit', 'homepage');
    });

    /* --- ЛОГИКА САЙТА --- */

    let currentRating = 0;
    let currentSystem = '';

    function rateAndGo(system) {
        currentSystem = system;
        currentRating = 0;

        // Трекаем, что человек нажал на кнопку выбора (еще не проголосовал)
        trackEvent('click', `choose_${system}`);

        document.getElementById('managerForm').style.display = 'none';
        document.getElementById(system + 'Stars').style.display = 'block';
        document.getElementById(system + 'GoBtn').style.display = 'inline-block';

        const other = system === 'yandex' ? 'google' : 'yandex';
        document.getElementById(other + 'Stars').style.display = 'none';
        document.getElementById(other + 'GoBtn').style.display = 'none';

        document.querySelectorAll('#' + system + 'Stars .star').forEach(s => s.classList.remove('selected'));
    }

    /* Выбор звезды */
    document.addEventListener('click', e => {
        if (e.target.classList.contains('star') && e.target.closest('.stars')) {
            const starsBlock = e.target.closest('.stars');
            currentRating = parseInt(e.target.dataset.v);
            starsBlock.querySelectorAll('.star').forEach((x, i) => x.classList.toggle('selected', i < currentRating));
        }
    });

    /* Отправка оценки */
    async function submitRating(system) {
        if (currentRating === 5) {
            // Трекаем успех и переход
            await trackEvent('click', `redirect_to_${system}`);
            
            if (system === 'yandex') {
                window.location.href = 'https://yandex.ru/maps/org/gio_s_gastrobar/217378885487/reviews/?ll=38.987867%2C55.808432&z=16';
            } else if (system === 'google') {
                window.location.href = 'https://www.google.com/search?q=Gio%27s+Gastrobar+Отзывы#lkt=LocalPoiReviews';
            }
        } else {
            // Трекаем, что оценка низкая, открываем форму
            trackEvent('view', `open_internal_form_${system}_rating_${currentRating}`);
            showForm();
        }
    }

    function showForm() {
        document.getElementById('managerForm').style.display = 'block';
        // Если открыли форму напрямую по кнопке "Отзыв управляющему"
        if(!currentSystem) trackEvent('click', 'open_manager_form_direct');
        
        window.scrollTo({ top: document.getElementById('managerForm').offsetTop, behavior: 'smooth' });
    }

    async function sendReview(e) {
        e.preventDefault();
        const fio = document.getElementById('fio').value.trim();
        const date = document.getElementById('date').value;
        const phone = document.getElementById('phone').value.trim();
        const text = document.getElementById('text').value.trim();

        if (!fio || !date || !phone || !text) { alert('Заполните все поля'); return; }

        await fetch('/send-telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fio, date, phone, text })
        });
        alert('Спасибо за отзыв!');
        e.target.reset();
        document.getElementById('managerForm').style.display = 'none';
    }
</script>
</body>
</html>
